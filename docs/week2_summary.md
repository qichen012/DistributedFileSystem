# 第二周项目总结

## 一、本周目标
在第一周实现了文件切块与基本的元数据存储功能后，本周的目标是：
1. 实现客户端上传文件块到存储节点的功能；
2. 搭建存储节点服务，支持文件块的存储与获取；
3. 实现存储节点自动注册到元数据服务；
4. 在调度器中实现从元数据服务动态获取节点地址；
5. 初步完成分散测试，确保各模块能够独立运行。

## 二、完成情况

### 1. 存储节点服务
- 在 `storage_nodes/node.py` 中实现了两个接口：
  - `POST /store_chunk`：存储文件块；
  - `GET /get_chunk`：根据 `file_id` 与 `chunk_index` 获取文件块。
- 存储节点启动时会自动创建本地存储目录 `./data/`。

### 2. 节点自动注册
- 存储节点在启动时会根据端口号生成自己的地址（如 `http://localhost:9001`）。
- 通过调用元数据服务的 `/node/register_node` 接口，将自己注册到数据库的 `storage_nodes` 表中。

### 3. 调度器更新
- 在 `controller/scheduler.py` 中实现了动态获取节点列表的功能：
  - 通过调用元数据服务的 `/node/list_nodes` 接口获取最新节点地址；
  - 以列表形式返回，后续可支持轮询等调度策略。

### 4. 测试
- 将测试分解为多个模块：
  - **文件切块测试**：验证 `split_file()` 输出的 chunk 数量与大小；
  - **存储节点测试**：上传并获取文件块，验证一致性；
  - **元数据服务测试**：文件与节点注册的正确性；
  - **调度器测试**：验证能否正确获取节点列表。

### 5. 问题与解决
- **问题 1**：`ModuleNotFoundError: No module named 'storage_nodes'`  
  **解决**：将 `uvicorn.run()` 的参数改为直接传 `app` 对象，或用 `python -m` 启动。
- **问题 2**：注册节点接口报错 `{'detail': 'Not Found'}`  
  **解决**：确认元数据服务是否正确挂载 `/node/register_node` 路由，并保证路径一致。

## 三、收获
- 学会了将功能分解到不同模块逐步测试，而不是一次性写全流程；
- 对 **FastAPI + SQLAlchemy** 的路由设计与模块划分更熟悉；
- 完成了分布式文件系统最关键的一环：**多存储节点的接入与调度**。

## 四、下周展望
- 实现文件下载功能：客户端能从多个节点下载 chunks 并合并为原文件；
- 加入简单的心跳检测，保证调度器只使用在线节点；
- 尝试初步编写全流程集成测试。